\chapter{Exploring Bifurcations between Phenotypes}
\label{chapter:exploring}
\begin{music}
    \parindent10mm \instrumentnumber{1} \setstaffs1{1} 
    \generalmeter{\meterfrac44} \generalsignature{2}
    \startextract
            \notes \ql j \ql i \Qqbl ieji \en
        \bar \zw{m*} \bar 
            \notes \ql i \qu h \Qqbu hdih \en
        \bar \zw{l*} 
    \zendextract
\end{music}
\epigraph{\textit{Who knows what might happen to those who are consumed by greed}}{Ocarina of Time}

\section{Preface}
\subsection{Problem Statement \& Context}
The studies in chapters \ref{chapter:double-exclusive}-\ref{chapter:inference} were carried out under the assumption that the underlying microscopic mechanisms that give rise to different phenotypes of an organism are known, and therefore can be modelled with differential equations that have interpretable parameters $\theta$. In section \ref{section:phenotype-inference} we outlined some popular machine learning approaches that can be used in settings where the underlying mechanism is partially or completely unknown. This chapter presents a study in immunology. While detailed models of the immune system exist \cite{}, in the advent of high-throughput biology new mechanisms and exceptions are continuously being discovered \cite{}. This is done by identifying immune cell populations, their function and mechanism of action from tissue and blood samples taken from an organism in homeostasis. \emph{Immunophenotyping} methods use antibodies to identify cells based on the types of antigens or markers on their surface. As we shall see, such datasets are typically high-dimensional data clouds that can be reduced with the help of \emph{universal function approximators} and clustered to identify different immune cell phenotypes. Such high-dimensional data clouds also appear in chapter \ref{chapter:inference} when optimal parameters $\theta$ reveal clusters of topologically or geometrically equivalent models.

In this chapter we argue the importance of interactive tools that allow immunologists to navigate high-dimensional data clouds from heterogeneous experimental setups. Such tools enable crowd-sourced consensus phenotyping of cell populations, discovery of rare populations and iterative refinement of a model of the immune system. An interactive tool \emph{FlowAtlas.jl} is presented in an adaptation of a manuscript prepared for \emph{Nature Methods: Brief Communications} at the time of writing the thesis. While the focus of this chapter remained grounded in immunology, we note these methods can be adapted to multi-omics data \cite{}. We conclude this chapter with a vision of how approaches in chapters \ref{chapter:inference} and \ref{chapter:exploring} can be combined to realise a high-throughput \emph{Design-Learn} pipeline.

\subsection{Contributions}
\textbf{Grisha Szep} is co-first author with \textbf{Valerie Coppard} and \textbf{Sarah Howlett}. \textbf{Joanne Jones}, \textbf{Daniel Rainbow}, \textbf{Sarah Howlett} and \textbf{Lorna Jarvis} conceived and designed the study. \textbf{Sarah Howlett}, helped by \textbf{Daniel Rainbow} and \textbf{Lorna Jarvis} acquired and processed donor tissue samples. \textbf{Valerie Coppard} designed the flow cytometry panels and performed the experiments. \textbf{Grisha Szep} conceived and implemented the computational pipeline and interactive software. All authors analysed and interpreted the data. \textbf{Grisha Szep}, \textbf{Valerie Coppard} and \textbf{Joanne Jones} wrote the main text. All authors provided input into the manuscript.
\clearpage

\section{Abstract}
\noindent As the dimensionality, throughput and complexity of cytometry data increases, so does the demand for user-friendly, interactive analysis tools that leverage high-performance machine learning frameworks. We introduce FlowAtlas.jl: an interactive web application that bridges the familiar user-friendly environment of FlowJo and computational tools in Julia developed by the rapidly growing scientific machine learning community. We demonstrate the workflow on a novel human multi-tissue, multi-donor dataset, addressing relevant biological questions with examples.

\section{Introduction}
Rapid advancements in flow and mass cytometry have brought about a new era of high-dimensional cell phenotyping. However, new algorithms and computational methods for dealing with high-dimensional data are typically not accompanied by user-friendly, flexible and interactive analysis tools. The wider biomedical research community relies on intuitive and transparent analysis for reaching consensus on discoveries. The uptake of currently available computational tools by biologists remains low, likely due to the lack of inter-operability with familiar platforms such as FlowJo and high entry requirements for computational literacy. Here we introduce FlowAtlas -- our effort to address the following issues:

\begin{itemize}
    \item Comparing insights from immunophenotyped datasets from heterogeneous experimental designs is difficult
    \item Navigating high-dimensional data in well-established tools like FlowJo or FCSExpress is difficult
    \item Limited computational resources require down-sampling data that may contain rare populations
    \item Pipelines built in scripting languages like R or Python have limited inter-operability with FlowJo
\end{itemize}

\begin{Figure}
    \includegraphics[width=12cm]{overview}
    \caption{Overview of FlowAtlas workflow with FlowJo. \textbf{a}, First, anomalous events are removed from the raw data. \textbf{b}, High-quality events are then pre-processed in FlowJo (Step 1). Pre-processed files are then opened in a new FlowJo workspace and prepared for FlowAtlas-assisted analysis: Step 2 annotation of fluorescence channels; Step 3 panel-specific gating of common populations across all datasets; Step 4 grouping of samples by desired conditions. Importing the updated workspace file into FlowAtlas triggers automatic panel merging, embedding calculation, and launches a graphical user interface (\textbf{c}), where embedded events can be re-coloured and filtered by groups and gates as defined in FlowJo. ROIs can be drawn directly in the embedding generating violin plots showing marker expression. Box plots can be generated to show  frequencies of selected populations and conditions relative to any population. Novel populations identified in FlowAtlas can be validated and annotated in FlowJo. The updated workspace file can then be re-opened in FlowAtlas to import new annotations.}
    \label{fig:overview}
\end{Figure}

We showcase the capabilities of FlowAtlas using a novel, human flow cytometry dataset, consisting of immune cells extracted from the tissues of five deceased organ donors and immunophenotyped using three slightly different antibody panels (see Extended Tables \ref{table:donors}--\ref{table:panels} for donor meta-data and panel information). FlowAtlas was designed for use in an iterative discovery loop with FlowJo, where traditional FlowJo gating strategies provide initial annotation of main cell populations, conditions, and sample grouping to guide the discovery of new sub-populations. With the help of EmbedSOM \cite{Kratochvil2018RapidEmbedSOM} we eliminated the need for data down-sampling during dimensionality reduction and expose visualisation methods with interactive library OpenLayers \cite{2006OpenLayers} to enable the visual exploration and profiling of hundreds of millions of cells. By imputing missing values before dimensionality reduction, using random sampling with replacement, datasets acquired using non-identical antibody panels can be integrated and analysed together. In order to remove algorithmic biases, the imputed values are neither visualised nor included in any downstream analysis.

\section{Proposed Method}

\subsection{Pre-processing}
First, we performed raw data clean-up using FlowAI \cite{GianniMonaco2017FlowAI}. We strongly recommend removing acquisition anomalies that result from sudden flow rate or signal acquisition instability (Figure \ref{fig:overview}, top grey box). High-quality files were then saved and imported into FlowJo for data pre-processing. In this step, we curated the compensation matrices for each dataset and gated out dead cells and aggregates (Figure \ref{fig:overview}, Step 1 FlowJo box). The live lymphocyte gate of each sample was then exported as a new FCS file containing only compensated fluorescence channels. Removing irrelevant events reduces the file size by approximately 40\%, substantially shortening embedding times (the most computationally intensive step in FlowAtlas). Thereafter, we imported the pre-processed data from Step 1 into sample groups in a new FlowJo workspace and assigned antibody labels to all fluorescence channels (Figure \ref{fig:overview} Step 2). Channel annotation in FlowJo must be done to resolve cases where there is a discrepancy between channel names defined at acquisition time from different panels. In our dataset, for example, some samples only had the signal from FoxP3 and others had both FoxP3 and IgM markers in one channel. By renaming FoxP3 to FoxP3-IgM in the relevant samples in FlowJo we can analyse both sample sets together in FlowAtlas.

\subsection{Annotation in FlowJo}
\begin{Figure}
    \includegraphics[width=\linewidth]{Extended_Fig_gating.pdf}
    \caption{Panel-specific gating strategies created in FlowJo.}
    \label{fig:gating}
\end{Figure}
Next, we created standard hierarchical gating using group-specific gating strategies (Figure \ref{fig:gating}) to define known populations of interest across all samples (Figure \ref{fig:overview} Step 3). Equivalent populations were assigned the same label. Cells that fall outside of FlowJo-defined gates are annotated as "Unlabelled" by FlowAtlas and can still be explored. Finally, to enable data exploration with selective filters we grouped our samples by donors and tissues; any number of groups is permissible (Figure \ref{fig:overview} Step 4). Sample grouping allows FlowAtlas to filter and colour-code embedded events. By default groups are interpreted as different "conditions" of a sample unless the group name contains numbers in which case the group is interpreted as a "batch". The user can rename and re arrange groups in FlowAtlas. In our dataset the "conditions" are different tissues and "batches" are different donors.

\subsection{Exploration in FlowAtlas.jl}
Finally the FlowJo workspace file is imported into FlowAtlas which triggers dataset merging, calculation of the embedding and opening a graphical user interface (Figure \ref{fig:overview}, FlowAtlas box). The embedding mapping is cached in file named with a ".som" extension. The same mapping can be used for different datasets as long as the marker names and the total number of channel dimensions match. To re-calculate the mapping simply delete the cache file. Sharing the cache file together with the FlowJo workspace and FCS files allows colleagues to work on the same embedding to verify findings in a reproducible manner. The graphical user interface has a map of the two dimensional embedding that was obtained by dimensionality reduction with EmbedSOM4. The map can be zoomed and panned and is rendered efficiently using OpenLayers \cite{2006OpenLayers}. The left-hand panel menu was designed with D3.js \cite{2011D3.js} and has four tabs: "Annotations", "Expression", "Frequency" and "Settings". The "Annotations" tab allows the user to filter and colour the embedding by marker expression, population, condition and batch information imported from FlowJo. The conditions and batches can also be re defined here. The "Expression" tab has a polygon draw tool that enables gating populations directly in the embedding fil- tered by settings in the "Annotations" tab. The gates produce violin plots (Figure 2c-d, Extended Figures 3-4) that reveal expression distributions across all markers. By clicking the violins it is possible to re-colour the gates to for a differential expression analysis. The "Frequency" tab generates box plots (Figure 2e, Extended Figure 2) showing frequencies of selected populations and conditions relative to any set of parent populations. The parental population, the "Conditions" axis and "Batches" marker colours are defined by settings in the "Annotations" tab. Once unique sub-populations have been identified in FlowAtlas, they can be then be validated in FlowJo, and new population gates created to be read by FlowAtlas at re-run. This "iterative discovery loop" simplifies the identification of rare or novel cell populations that may otherwise be missed by data down-sampling or under-fitting in existing unsupervised clustering approaches. All figures can be exported as publication-quality SVG vector graphics.

\section{Results}

\subsection{T-cell Sub-populations}
\begin{Figure}
    \includegraphics[width=14cm]{Main-figure-2.pdf}
    \caption{Treg sub-population discovery in FlowAtlas. \textbf{a}, Relative abundance of Tregs by donor and tissue calculated as \% total CD4\textsuperscript{+} T-cells. \textbf{b}, Self-organised map embedding of Tregs from all tissues for Panel C donors coloured by Helios expression. \textbf{c}, Panel-specific violin-plots showing marker expression and embedding geometry differences in Treg population. \textbf{d}, Marker expression of four ROIs within the Treg embedding of all tissues. \textbf{e}, Four ROIs within Treg embedding visualised by tissue. \textbf{f}, Validation and creation of new Treg sub-gates for four ROIs in FlowJo. \textbf{g}, Treg embedding re-coloured by the newly identified Treg populations and their corresponding frequencies across tissues and donors. tLN - thoracic lymph nodes; ROI - region of interest; FJ - FlowJo; FA - FlowAtlas.jl}
    \label{fig:tregs}
\end{Figure}
To demonstrate the power of FlowAtlas we zoomed into the CD4 Treg populations (Figure 2) as defined in our gating strategies for each panel (Extended Figure 1). Tregs were enriched in mesenteric lymph nodes, accounting for more than 20\% of all CD4 T-cells across all donors (Figure 2a). The embedding of Tregs for all donors and tissues, coloured by the expression of the Ikaros family transcription factor Helios (Figure 2b), revealed Helios+ and Helios-sub-populations as expected \cite{thornton_helios_2019,himmel_helios_2013}, with additional sub-clusters which may be genuine sub-populations, or emerge from a batch effect, or a combination of both. We assessed inter experimental and inter-panel batch effects by colouring cells by panel and looking for differences in cluster position, geometry and marker mean fluorescence intensity (MFI). While inter-batch variability existed, the relative positions of four clusters in the Treg embedding was conserved across panels (Figure 2c). Differential expression in violin plots revealed variation due panel design, e.g. lower CD4 MFI for panels B and C (pink and blue lines respectively) compared to panel A, due to use of a different fluorochrome (see Extended Table 3).

We focused on panel C to explore Treg sub-cluster characteristics further, then validated our findings in samples obtained using Panels A and B. The Treg embedding was filtered by samples collected using Panel C and coloured by tissue of origin. With this view four sub-clusters could be identified and gated to obtain violin plots (Figure 2d). Differential expression between gated clusters revealed that CD45RA,CCR7, CCR4 and CD69 explain the majority of variability between clusters. We identify one naive Treg phenotype (CD45RA+CCR7+) three populations showing characteristics of memory subsets (CD45RA CCR7-). The three memory subsets can be further subdivided in a CCR4,CD69 quadrant (shown in different colours in Figure 2d). Two subsets were found to express CD69+ - a marker of tissue residency that promotes retention through sequestration of the sphingosine-1-phosphate receptor S1P1 required for their egress \cite{shiow_cd69_2006,kumar_human_2017,sathaliyawala_distribution_2013}. Dividing the embedding by tissue revealed tissue-specific enrichment patterns, with blood lacking the CD69+ subsets, consistent with their tissue residency phenotype.

Finally, we validated the presence of these four subsets in all panels in FlowJo (Figure \ref{fig:tregs}f) creating new FlowJo gates for further exploration in FlowAtlas. Returning to FlowAtlas, the Treg embedding was re-coloured by these newly annotated subsets and relative frequency box plots generated (Figure \ref{fig:tregs}g). This confirmed tissue specific distribution of these subsets observed in FA (Figure \ref{fig:tregs}e), with few CD69\textsuperscript{+} Tregs in blood, while lung and liver contained a high proportion of Tregs expressing the chemokine receptor CCR4\textsuperscript{+} (with and without CD69 co-expression). CCR4 has been reported to play an important role in T-cell trafficking to the lung \cite{mikhak_lung_2013}, and in the infiltration of Tregs into tumours \cite{bromley_orchestrating_2008}. This iterative discovery loop can be performed for any other population of interest, as shown for the CD4 Th1 and CD8 memory cell compartments (Extended Figures \ref{fig:Extended_Th1}-\ref{fig:Extended_CD8}).

\begin{Figure}
    \includegraphics[width=\linewidth]{Extended_Th1.pdf}
    \caption{Exploratory analysis of Th1 T-cell subpopulations. FlowAtlas-generated embedding of Th1 subset from all tissues of donors in Panel C, were coloured by tissue of origin and displayed as composite embedding as well as tissue-specific embeddings. ROIs were drawn around four subclusters in the composite embedding to auto-generate subcluster-specific violin plots of marker expression. This revealed four distinct subpopulations with indicated phenotypes. Tissue-specific embedding shows that blood is lacking the population marked with red ROI and characterised by the co-expression of CD69 and CD127.}
    \label{fig:Extended_Th1}
\end{Figure}

\begin{Figure}
    \includegraphics[width=\linewidth]{Frequencies_Th.pdf}
    \caption{Relative abundance of main cell subsets by donor and tissue. Percent of B and T cells are calculated relative to their sum. B cell markers were only present in Panel C. Blood was available only for donrs 412C and 423C. CD4 and CD8 subsets are calculated relative to their respective parent population as indicated. As expected B cells were rare in liver in lung, but were enriched in lymphoid tissues (spleen, lymph nodes and bone marrow) relative to blood. Within the T-cell compartment CD4 T-cell subsets, especially CM and naïve, were enriched in lymph nodes, whereas ileum, liver, and lung were dominated by CD8 cells, particularly EM and TEMRAs. Within the CD4 memory compartment, frequencies of T helper cell subsets was variable across donors and tissues, with Th2 cells being most frequent in blood.     CM - central memory, EM - effector memory; TEMRA - T effector memory cells re-expressing CD45RA.}
    \label{fig:Frequencies}
\end{Figure}

\begin{Figure}
    \includegraphics[width=\linewidth]{Extended_fig_CD8_CD69.pdf}
    \caption{Exploratory analysis of the CD8\textsuperscript{+} T cell population. FlowAtlas-generated embedding of CD8\textsuperscript{+} subset from all tissues of donors in Panel C, as defined by the initial FlowJo gating strategy, were coloured by memory and naive subpopulations as well as by heatmaps of CD103 and CD69 expression and displayed as composite embedding and as tissue specific embeddings. ROIs were drawn around four of many potential subclusters in the composite embedding to auto-generate subcluster specific violin plots of marker expression. As can be seen, naive CD8 cells were absent from the liver, lung and spleen. CM CD8 cells were mainly present in the blood, spleen and lymph nodes, as expected. Liver was dominated by cells with a TEMRA phenotype, and lung and ileum by EM CD8 cells. In keeping with its role in tissue retention, CD69\textsuperscript{+} CD8 cells were largely absent from blood but present in tissues. Although few cells were obtained from the ileum, they nearly all co-expressed CD69 and the integrin CD103 as has been described \cite{kumar_human_2017,sathaliyawala_distribution_2013,booth_characterization_2014}}
    \label{fig:Extended_CD8}
\end{Figure}

% Here, we present FlowAtlas.jl --- our effort to address the growing need for high-performance, flexible and interactive analysis tools that enable the visual, exploration and profiling of hundreds of millions of cells in high-dimensional flow cytometry datasets with no data downsampling or command line input. FlowAtlas.jl is fully inter-operable with FlowJo, allows concomitant analysis of datasets created with non-identical panel designs and empowers researchers to explore data in a fully interactive, graphical environment using a new analysis concept.
% We showcase the capabilities of FlowAtlas.jl using a novel, human flow cytometric dataset, consisting of immune cells extracted from the tissues of five deceased organ donors, collected over a 5-month period and stained using three slightly different antibody panels. 

% This work is presented in an effort to strengthen the open-source collaborations between researchers using flow cytometry and the rapidly growing scientific machine learning community in Julia programming language.

% FlowAtlas.jl is designed to be used in an iterative discovery loop with FlowJo, where traditional gating strategies created in FlowJo provide initial annotation of main populations, conditions, and sample filtering options to guide the discovery of new sub-populations in FlowAtlas.jl, inside and outside of the specified gates. To prevent the need for downsampling, we implemented \textit{EmbedSOM} \cite{Kratochvil2018RapidEmbedSOM} a powerful dimensionality reduction method. State-of-the-art missing value handling methods and novel features within FlowAtlas.jl also allow users to merge flow cytometry datasets acquired using different antibody panels enabling their concomitant analysis. For example, in our dataset three  panel designs were used (see Table \ref{table:panels}), where CD4 was assigned to BUV661 in Panel A and to BUV805 in Panels B and C. In addition, Panel C had three B cell makers not present in Panels A or B, whereas Panel A had CD45 which was not present in Panels B and C. Consequently, three panel-specific gating strategies were created in FlowJo (see Extended Figure \ref{fig:gating}) to define common cell populations. FlowAtlas.jl was then able to seamlessly merge these datasets using channel marker annotations provided by the user in FlowJo, and combine equivalent cell populations based on their annotations irrespective of panel-specific gating strategy. Analysis steps are outlined in Figure \ref{fig:overview}.

% standard hierarchical gating of high-level cell subsets. Samples acquired with different panel designs should be imported into the same FlowJo workspace but separated into different groups and gated with group-specific gating strategy. The goal is to implement panel-appropriate gating, while defining common cell subsets across all sample groups. It is critical to label equivalent populations across all datasets with a common name irrespective of gating strategy that defines them as they are automatically imported into FlowAtlas.jl and used for all further analysis. For example, CD4 effector memory (CD4EM) T cells can be gated differently depending on panel design as illustrated in our dataset see Extended Figure \ref{fig:gating} but they should be labelled as CD4EM in every panel.  In order to ensure successful panel merging by FlowAtlas.jl, all fluorescent channels must also be annotated with their respective markers in FlowJo. Although panel merging precludes differential analysis of expression densities using MFI values for non-identical panels, it still allows qualitative and cell frequency comparisons of common populations across such datasets.

% Next, to enable a flexible and intuitive data exploration, group all samples into as many groups as would be informative for exploratory analysis (for example group samples by donor, tissue, treatment, panel, etc). FlowAtlas.jl imports these gate names to population labels without requiring the gating strategies to be the same across different samples and allowing comparative analysis of these populations across datasets. Cells that fall outside of FlowJo-defined gates will be automatically placed into the "Unlabelled" population by FlowAtlas and can be fully explored.

% Next, import FlowJo analysis workspace file (.wsp extension) into FlowAtlas.jl, which will trigger automatic dataset merging and calculation of embedding (Figure \ref{fig:overview}, FlowAtlas box). The embedding computation is performed only once and the embedding file with .som extension is stored in the FlowAtlas.jl folder. This file stores the topology of computed clusters and allows users to quickly return to their analysis. Sharing a .som file together with .wsp and .FCS files with colleagues will allow everyone to work on the same embedding topology and easily confirm findings and analysis reproducibility. Once the computation is complete, FlowAtlas.jl will open a graphical analysis environment in your default browser (Figure \ref{fig:overview}, FlowAtlas box).
% We leverage high-performance library GigaSOM.jl \cite{Kratochvil2020GigaSOM.jl:Datasets} and interactive visualisation libraries D3.js \cite{2011D3.js} and OpenLayers \cite{2006OpenLayers} to make the embedding fully interactive, with zooming, panning, event filtering and colouring by marker expression densities or any custom condition (such as sample group) provided by the researcher in FlowJo and where unlimited number of areas of interest (AOI) can be drawn directly in the data embedding for comparative analysis of marker expression with violin plots or comparative frequency analysis of selected cell populations and conditions using box plots. 
% For example, Figure \ref{fig:overview} (FlowAtlas box) shows how selecting B cells and CD4 T cell subsets in Liver of donor 412C will display embedding of only cells defined and colour-coded by these filters and allow users to easily identify fine differences in the underlying sub-cluster structures. Any number of such sub-clusters can be interactively compared to each other by drawing colour-coded AOI directly in the embedding and displaying overlayed violin plots of sub-cluster-specific marker expression. Once unique sub-populations are identified, they can be validated in FlowJo where new population gates defining these cells can be created. The new populations will then be read by FlowAtlas.jl and statistics output can be created or further exploration performed. The gating strategy in FlowJo can thus be iteratively updated with new Cell populations discovered in FlowAtlas.jl. The iterative discovery process simplifies the identification of rare or novel cell populations that would otherwise be missed due to data down-sampling or under-fitting in unsupervised clustering approaches.

% We used total CD4 Treg population (defined in Figure \ref{fig:gating}) to illustrate how new sub-populations can be easily and intuitively identified in FlowAtlas.jl (Figure \ref{fig:tregs}). First, relative population frequency boxplot statistics can be generated for total Treg population across all tissues and panels (Figure \ref{fig:tregs}a). The statistics is calculated relative to the top-level parental population selected in the FlowAtlas.jl or relative to a sum of all selected populations. In our dataset, total Treg represented over 20\% of CD4 T cells in mesenteric lymph nodes in all donors.
% Displaying the embedding of total Treg cells for all donors and tissues of Panel C and colouring cells by density of Helios expression (Figure \ref{fig:tregs}b) shows that total Treg population is comprised of Helios\textsuperscript{+} and Helios\textsuperscript{-} sub-populations. Zooming into the embedding reveals additional sub-cluster structures that warrant exploration. Before any further analysis, batch effects that arise due to inter-experimental or inter-panel variability can be easily detected by colouring a cell population by its panel or experiment of origin and observing differences in cluster position, geometry and marker MFI as we did for tot Treg in Figure \ref{fig:tregs}c. Note how CD4 MFI creates a bimodal distribution due to different fluorochrome used in Panel A. Although some differences in cluster locations are notable between panels, overall Treg population embedding looks consistent. Next, we used Panel C as a reference for further exploration of sub-cluster characteristics. Once they are defined, same results can be obtained for Panels A and B (Extended Figure is coming). For this, we re-coloured tot Treg embedding shown in b, by tissue origin, drew AOI around individual sub-clusters and inspected the differences in marker expression using auto-generated violin plots (Figure \ref{fig:tregs}d). This showed a clear difference in the expression of CD45RA, CCR7, CCR4 and CD69 between individual AOI, with red having a naive phenotype CD45RA\textsuperscript{+}CCR7\textsuperscript{+}CCR4\textsuperscript{-}CD69\textsuperscript{-}, while yellow, grey and violet showing characteristics of memory subset.
% Yellow CD45RA\textsuperscript{-}CCR7\textsuperscript{-}CCR4\textsuperscript{+}CD69\textsuperscript{-}
% Grey CD45RA\textsuperscript{-/lo}CCR7\textsuperscript{-}CCR4\textsuperscript{-}CD69\textsuperscript{+} and violet CD45RA\textsuperscript{-}CCR7\textsuperscript{-}CCR4\textsuperscript{+}CD69\textsuperscript{+}. Grey and yellow memory subsets are D69\textsuperscript{+ } - a sign of tissue homing. Dividing the embedding by tissue reveals differences in tissue specific enrichment of individual Treg subsets. With blood lacking the grey and violet subsets, which is in line with their tissue homing phenotype. Next, we validated the presence of these subsets in FlowJo (Figure \ref{fig:tregs}e). Plotting CD69 vs CCR4 for tot Treg subset in thoracic lymph nodes (tLN) clearly shows the presence of the four sub-populations identified in FlowAtlas.jl. We created new FlowJo gates corresponding to the four subsets and returned to FlowAtlas.jl where we re-coloured Treg embedding by these subsets. This revealed that each individual subset includes both Helios\textsuperscript{+} and Helios\textsuperscript{-} sub-populations (refer to the density of Helios expression shown in b). Since FJ gates for the four new Treg subsets have been gated and read by FA, population frequency statistics can be automatically generated (box plots).

\section{Discussion}

In conclusion, FlowAtlas brings a new iterative analysis concept to biomedical scientists by linking the familiar FlowJo workflow with a high-performance machine learning framework in a fully graphical, interactive environment. FlowAtlas allows rapid computation of embedding of millions of high-dimensional events on an average laptop without the need for down-sampling. The resulting embedding is highly interactive, offering zooming to explore deeper cluster structures, colouring and filtering of
embedded events by custom conditions, the generation frequency statistics and the drawing of gates directly in the
embedding for comparative analysis of marker expression.
Moreover, state-of-the-art missing data handling methods enable concomitant cross-study analysis of datasets
with non-identical panel designs or marker numbers. Findings can be immediately validated in FlowJo in an iterative
discovery loop with FlowAtlas simplifying the identification
and validation of rare or novel cell populations, which are
more likely to be detected in the absence of down-sampling.
FlowAtlas aims to strengthen the open-source collaborations between researchers using flow cytometry and the
rapidly growing scientific machine learning community in
Julia programming language.

\section{Methods}

\subsection{Tissue Acquisition \& Dissociation} 

All samples were collected via the \href{https://www.cbtm.group.cam.ac.uk}{Cambridge Biorepository for Translational Medicine} under Research Ethics Committee approval 15/EE/0152. Tissue was obtained from five deceased organ donors following circulatory death. Donor metadata is given in Extended Data Table \ref{table:donors}. Briefly, following cessation of circulatory function donors proceeded to organ donation. Organs were perfused \emph{in situ} with cold organ preservation solution and cooled with topical application of ice. Samples for the study were obtained within 60 minutes of cessation of circulation and placed in University of Wisconsin organ preservation solution for transport at 4°C to the laboratory. Lung and liver samples were obtained from the left lower lobe of the lung and the right lobe of the liver. In addition, two donor-matched blood samples were collected prior to withdrawal of life support, under approval 97/290.

To minimise the possibility of processing-depended differences in cell surface marker expression, all samples, including blood, were processed using enzymatic digestion protocol. Briefly, solid tissues were weighed, transferred into 10cm tissue culture dishes and cut into small pieces. Up to 5g of tissue was then transferred to each of eight GentleMACS C tubes (Miltenyi Biotec) containing 5mL of dissociation media composed of X-vivo15 supplemented with 0.13U/mL Liberase TL (Roche), 10U/mL Benzonase nuclease (Millipore/Merck), 2\% (v/v) heat-inactivated fetal bovine serum (FBS, Gibco), penicillin (100 U/ml, Sigma-Aldrich), streptomycin (0.1 mg/ml, Sigma-Aldrich), and 10mM HEPES (Sigma Aldrich). The samples were then dissociated on a GentleMACS Octo dissociator (Miltenyi Biotec) running a protocol that provided gradual ramping up of homogenisation speed and two 15 minute heating/mixing steps at 37°C. Digested tissue was passed through a 70$\mu$m MACS Smartstrainer (Miltenyi Biotec) and the flow-through was first washed with media supplemented with 2 mM EDTA and then with PBS. Mononuclear cells were enriched by Ficoll-Paque (GE Healthcare) density centrifugation according to manufacturer's instructions. Following, density centrifugation, mononuclear layer was collected, washed once with PBS and cell pellet was resuspended in FACS buffer (PBS, 2.5$\%$ FBS).

Bone marrow aspirates and peripheral blood samples were first subjected to Ficoll-Paque density centrifugation, according to manufacturer's instructions, the mononuclear layer was then collected, washed with PBS and cells were treated with the same dissociation media as solid tissues for 30 min at 37°C prior to washing and resuspension in FACS buffer.

\subsection{Flow Cytometry}

Depending on the cell yield, up to 1x10\textsuperscript{6} mononuclear cells/tissue were stained with antibodies shown in Extended Data Table \ref{table:panel}. Not all donors were stained with the same panel. To expand total number of markers, sentinel panel design was implemented where CD3 and IgD were detected with antibodies conjugated to BUV395 and Foxp3 and IgM were detected with antibodies conjugated to PE in some donors. Refer to Extended Data Table \ref{table:panels} for details. 

Single cell suspensions were washed once in PBS, transferred into 96 v-bottom plate and stained with Zombie UV viability dye for 30 min at 4°C following by a wash with FACS buffer. Cell pellets were resuspended in 50$\mu$l FACS buffer with Human FcR block (BD Biosciences) and incubated for 10 min at 4°C. Next, cells were pelleted, excess buffer removed and 100$\mu$l of antibody master mix composed of cell-surface antibody cocktail (see Table Extended Data \ref{table:panels}), BV buffer (BD) and True-Stain Monocyte Blocker (Biolegend) and incubated for 1h at 4°C. Following incubation, cells were washed three times in PBS and prepared for intracellular staining using transcription factor fixation/permeabilisation kit (eBioscience) according to the manufacturer's instructions. Following IC staining, cell were resuspended in PBS and analysed on BD FACSymphony A3 cell analyser within 10 hours.

% \subsection{Imputation \& Embedding}

% When some markers are not present in every dataset, cells for which a marker is missing are not displayed in the embedding when the embedding is coloured by the expression of the missing marker in FlowAtlas.jl. To compute the initial embedding, however, missing values are sampled from non-missing values. 

% or re-use embedding transformations on new datasets. Note that the number of channels and names of the new dataset must match those used to calculate the embedding. With this approach it is possible to calculate an embedding for a sub-sampled dataset to save time and use the resultant transformation on the whole dataset to retain the embedding coordinates of rare populations.
% Enables novel population discovery

\subsection{Data \& Code Availability}
All data is made available in \href{https://flowrepository.org}{\texttt{FlowRepository}}. Code and installation instructions can be found in our GitHub \href{https://github.com/gszep/FlowAtlas.jl}{\texttt{github.com/gszep/FlowAtlas.jl}}

\section{Afterword}

% \subsection{Julia \& SciML}
% \subsection{OpenLayers \& Data-driven Documents}
% \subsection{Interactivity}
% \subsection{Dataset Integration}